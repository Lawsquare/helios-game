<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios 连接测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #5a6fd8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 Helios 系统测试</h1>
        
        <div class="test-section">
            <h3>1. 配置检查</h3>
            <p>检查基本配置是否正确加载</p>
            <button onclick="testConfig()">检查配置</button>
            <div id="config-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. n8n连接测试</h3>
            <p>测试与n8n webhook的连接</p>
            <input type="text" id="webhook-url" placeholder="输入您的n8n webhook URL">
            <button onclick="testN8nConnection()">测试连接</button>
            <div id="n8n-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. 数据库连接测试</h3>
            <p>测试Supabase数据库连接（需要您提供API密钥）</p>
            <input type="text" id="supabase-url" placeholder="Supabase URL">
            <input type="text" id="supabase-key" placeholder="Supabase API Key">
            <button onclick="testDatabase()">测试数据库</button>
            <div id="db-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. 完整流程测试</h3>
            <p>测试完整的意识转化流程</p>
            <input type="text" id="test-message" placeholder="输入测试消息，如：我想要变得更自信">
            <select id="test-character">
                <option value="shy_student">内向学生</option>
                <option value="ambitious_worker">上进青年</option>
                <option value="lonely_artist">孤独艺术家</option>
                <option value="anxious_parent">焦虑家长</option>
            </select>
            <button onclick="testFullFlow()">测试完整流程</button>
            <div id="flow-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. 浏览器兼容性</h3>
            <p>检查浏览器是否支持所需功能</p>
            <button onclick="testBrowserCompatibility()">检查兼容性</button>
            <div id="browser-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        function testConfig() {
            try {
                const config = {
                    webhookUrl: typeof N8N_WEBHOOK_URL !== 'undefined' ? N8N_WEBHOOK_URL : '未定义',
                    apiConfig: typeof API_CONFIG !== 'undefined' ? API_CONFIG : '未定义',
                    appConfig: typeof APP_CONFIG !== 'undefined' ? APP_CONFIG : '未定义'
                };
                
                let message = '配置检查结果:\n';
                message += `Webhook URL: ${config.webhookUrl}\n`;
                message += `API配置: ${JSON.stringify(config.apiConfig, null, 2)}\n`;
                message += `应用配置: ${JSON.stringify(config.appConfig, null, 2)}`;
                
                showResult('config-result', message, 'success');
            } catch (error) {
                showResult('config-result', `配置检查失败: ${error.message}`, 'error');
            }
        }

        async function testN8nConnection() {
            const webhookUrl = document.getElementById('webhook-url').value || N8N_WEBHOOK_URL;
            
            if (!webhookUrl || webhookUrl.includes('your-n8n-instance.com')) {
                showResult('n8n-result', '请先配置正确的n8n webhook URL', 'error');
                return;
            }

            try {
                showResult('n8n-result', '正在测试连接...', 'info');
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chatInput: '测试连接',
                        character_id: 'shy_student',
                        sessionId: 'test_session'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('n8n-result', `连接成功!\n响应: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('n8n-result', `连接失败: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('n8n-result', `连接错误: ${error.message}`, 'error');
            }
        }

        async function testDatabase() {
            const supabaseUrl = document.getElementById('supabase-url').value;
            const supabaseKey = document.getElementById('supabase-key').value;

            if (!supabaseUrl || !supabaseKey) {
                showResult('db-result', '请输入Supabase URL和API密钥', 'error');
                return;
            }

            try {
                showResult('db-result', '正在测试数据库连接...', 'info');
                
                const response = await fetch(`${supabaseUrl}/rest/v1/characters?select=*`, {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('db-result', `数据库连接成功!\n角色数量: ${data.length}\n数据: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('db-result', `数据库连接失败: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('db-result', `数据库错误: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            const message = document.getElementById('test-message').value;
            const character = document.getElementById('test-character').value;

            if (!message) {
                showResult('flow-result', '请输入测试消息', 'error');
                return;
            }

            try {
                showResult('flow-result', '正在测试完整流程...', 'info');
                
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chatInput: message,
                        character_id: character,
                        sessionId: 'test_session_' + Date.now()
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('flow-result', `完整流程测试成功!\n输入: ${message}\n角色: ${character}\n输出: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('flow-result', `流程测试失败: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('flow-result', `流程测试错误: ${error.message}`, 'error');
            }
        }

        function testBrowserCompatibility() {
            const tests = {
                'Fetch API': typeof fetch !== 'undefined',
                'Local Storage': typeof localStorage !== 'undefined',
                'JSON支持': typeof JSON !== 'undefined',
                'ES6箭头函数': (() => true)(),
                'Promise支持': typeof Promise !== 'undefined',
                'async/await支持': (async () => true)() instanceof Promise
            };

            let message = '浏览器兼容性检查:\n';
            let allPassed = true;

            for (const [test, result] of Object.entries(tests)) {
                message += `${test}: ${result ? '✅ 支持' : '❌ 不支持'}\n`;
                if (!result) allPassed = false;
            }

            message += `\n总体评估: ${allPassed ? '✅ 完全兼容' : '❌ 存在兼容性问题'}`;
            
            showResult('browser-result', message, allPassed ? 'success' : 'error');
        }

        // 页面加载时自动检查配置
        window.addEventListener('load', function() {
            testConfig();
            testBrowserCompatibility();
        });
    </script>
</body>
</html>
